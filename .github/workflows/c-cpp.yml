name: Build and Release

on:
  push:
    branches: [ "master" ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Important for git history-based versioning
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc make libcurl4-openssl-dev libjson-c-dev libncurses-dev
    
    - name: Build project
      run: |
        make rebuild
        
    - name: Create package
      run: |
        mkdir -p dist
        cp anime-cli dist/
        cp README.md LICENSE dist/
        VERSION=$(git describe --tags --abbrev=0)
        cd dist
        tar -czvf ../anime-cli.tar.gz *
    
    - name: Create Release and Upload Asset
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        RELEASE_NOTES="Automated build from commit ${{ github.sha }}\n\n**Changes in this release:**\n${{ github.event.head_commit.message }}"
        
        # Create release using GitHub CLI
        gh release create "v$VERSION" \
          --title "Release $VERSION" \
          --notes "$RELEASE_NOTES" \
          "./anime-cli.tar.gz#anime-cli-$VERSION.tar.gz"